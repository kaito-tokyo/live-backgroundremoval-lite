name: 'ğŸ’¬ Gemini First Reply'

on:
  workflow_call:

concurrency:
  group: '${{ github.workflow }}-first-reply-${{ github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  reply:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 5
    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'read'
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b' # ratchet:actions/create-github-app-token@v2
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          permission-issues: 'write'

      - name: 'Run Gemini CLI for First Reply'
        id: 'run_gemini'
        uses: 'google-github-actions/run-gemini-cli@v0' # ratchet:exclude
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_NUMBER: '${{ github.event.issue.number }}'
          ISSUE_TITLE: '${{ github.event.issue.title }}'
          ISSUE_BODY: '${{ github.event.issue.body }}'
          ISSUE_AUTHOR: '${{ github.actor }}'
          REPOSITORY: '${{ github.repository }}'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}'
          google_api_key: '${{ secrets.GOOGLE_API_KEY }}'
          use_gemini_code_assist: '${{ vars.GOOGLE_GENAI_USE_GCA }}'
          gemini_debug: true
          #gemini_debug: '${{ fromJSON(vars.DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}'
          settings: |-
            {
              "maxSessionTurns": 5,
              "telemetry": {
                "enabled": ${{ vars.GOOGLE_CLOUD_PROJECT != '' }},
                "target": "gcp"
              },
              "mcpServers": {
                "github": {
                  "httpUrl": "https://api.githubcopilot.com/mcp/",
                  "trust": true,
                  "headers": {
                    "Authorization": "Bearer $GITHUB_TOKEN"
                  }
                }
              },
              "coreTools": ["run_shell_command(echo)"]
            }
          prompt: |-
            ## Role
            ã‚ãªãŸã¯ã€GitHubãƒªãƒã‚¸ãƒˆãƒªã®è¦ªåˆ‡ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã‚ãªãŸã®ç›®çš„ã¯ã€æ–°ã—ãä½œæˆã•ã‚ŒãŸIssueã«å¯¾ã—ã¦æœ€åˆã®è¿”ä¿¡ã‚’è¡Œã„ã€èµ·ç¥¨è€…ã‚’æ­“è¿ã—ã€IssueãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã‚ˆã†ã«æ‰‹åŠ©ã‘ã™ã‚‹ã“ã¨ã§ã™ã€‚

            ## Goal
            ${ISSUE_AUTHOR}ã•ã‚“ã«ã‚ˆã£ã¦èµ·ç¥¨ã•ã‚ŒãŸIssue #${ISSUE_NUMBER} ã«å¯¾ã—ã¦ã€æœ€åˆã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚

            ## Instructions
            1.  **èµ·ç¥¨è€…ã¸ã®æŒ¨æ‹¶**: ã¾ãšã€`@${ISSUE_AUTHOR}`ã•ã‚“å®›ã«æŒ¨æ‹¶ã—ã€Issueã‚’èµ·ç¥¨ã—ã¦ãã‚ŒãŸã“ã¨ã¸ã®æ„Ÿè¬ã‚’ä¼ãˆã¾ã™ã€‚
            2.  **å†…å®¹ã®ç¢ºèª**: Issueã®ã‚¿ã‚¤ãƒˆãƒ«ã€Œ${ISSUE_TITLE}ã€ã¨æœ¬æ–‡ã®å†…å®¹ã‚’ç°¡æ½”ã«è¦ç´„ã—ã€å†…å®¹ã‚’ç†è§£ã—ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
            3.  **åˆæœŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®æä¾›**: Issueã®å†…å®¹ã‚’åˆ†æã—ã€å¯èƒ½ã§ã‚ã‚Œã°å½¹ç«‹ã¤åˆæœŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
                - **ãƒã‚°å ±å‘Šã®å ´åˆ**: ã€Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã—ãŸã‹ï¼Ÿã€ã‚„ã€Œå†ç¾æ‰‹é †ã‚’ã‚ˆã‚Šè©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã€ãªã©ã®è³ªå•ã‚’ã—ã¾ã™ã€‚
                - **æ©Ÿèƒ½è¦æœ›ã®å ´åˆ**: ã€Œç´ æ™´ã‚‰ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã€ã¨ã„ã£ãŸè‚¯å®šçš„ãªåå¿œã‚’ç¤ºã—ã¾ã™ã€‚
                - **è³ªå•ã®å ´åˆ**: é–¢é€£ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’æç¤ºã™ã‚‹ãªã©ã€è‡ªå·±è§£æ±ºã‚’ä¿ƒã™æƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚
            4.  **ç· ã‚**: æœ€å¾Œã«ã€ã€Œæ‹…å½“è€…ãŒç¢ºèªã—ã¾ã™ã®ã§ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚ã€ã¨ã„ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç· ã‚ããã‚Šã¾ã™ã€‚
            5.  **å®Ÿè¡Œ**: `mcp__github__add_issue_comment`ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€ä½œæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚

            ## Constraints
            - ã‚³ãƒ¡ãƒ³ãƒˆã¯å¸¸ã«ä¸å¯§ã§ã€å”åŠ›çš„ãªãƒˆãƒ¼ãƒ³ã‚’ä¿ã£ã¦ãã ã•ã„ã€‚
            - Issueã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ãŸã‚Šã€ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚ã‚ãªãŸã®å½¹å‰²ã¯ã‚ãã¾ã§æœ€åˆã®å¿œå¯¾ã§ã™ã€‚