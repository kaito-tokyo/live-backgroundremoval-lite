---
import { joinURL, withTrailingSlash } from "ufo";
import { Octokit } from "@octokit/rest";
import prettyBytes from "pretty-bytes";
import type { GetStaticPathsOptions, GetStaticPathsResult } from "astro";

import {
  GITHUB_OWNER,
  GITHUB_REPO,
  GITHUB_URL,
  PRODUCTION_BASE_URL,
} from "../../lib/info.js";
import DefineLocalDate from "../../components/DefineLocalDate.astro";
import Layout from "../../layouts/Layout.astro";

interface Props {
  release: Awaited<
    ReturnType<Octokit["rest"]["repos"]["getReleaseByTag"]>
  >["data"];
  latestRelease: Awaited<
    ReturnType<Octokit["rest"]["repos"]["getLatestRelease"]>
  >["data"];
}

export async function getStaticPaths(
  options: GetStaticPathsOptions,
): Promise<GetStaticPathsResult> {
  const octokit = new Octokit({ auth: import.meta.env.GITHUB_TOKEN });

  const allReleases = await octokit.paginate(octokit.rest.repos.listReleases, {
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
    per_page: 100,
  });

  const latestRelease = await octokit.rest.repos.getLatestRelease({
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
  });

  return allReleases.map((release) => ({
    params: { version: release.tag_name },
    props: { release, latestRelease: latestRelease.data },
  }));
}

const { BASE_URL } = import.meta.env;

function stripMarkdown(markdown: string): string {
  if (!markdown) return "";

  return markdown
    .replace(/^#+\s+/gm, "")
    .replace(/^[\s\-*+]+/gm, "")
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
    .replace(/```/g, "")
    .replace(/[*_]{1,2}([^*_]+)[*_]{1,2}/g, "$1")
    .replace(/\s+/g, " ")
    .trim();
}

const { release, latestRelease } = Astro.props;

const windowsZipAsset = release.assets.find((a) =>
  a.name.endsWith("windows-x64.zip"),
);
const macosPkgAsset = release.assets.find((a) =>
  a.name.endsWith("macos-universal.pkg"),
);
const ubuntuDebAsset = release.assets.find((a) =>
  a.name.endsWith("x86_64-linux-gnu.deb"),
);

const releaseBody = release.body || "No release notes provided.";

const baseDescription = `Download version ${release.tag_name} of Live Background Removal Lite.`;
const cleanBody = stripMarkdown(releaseBody);
const dynamicDescription = cleanBody
  ? `${baseDescription} Highlights: ${cleanBody}`.substring(0, 160) +
    (cleanBody.length > 100 ? "..." : "")
  : `${baseDescription} Check release notes for details.`;

const supportedOSList = [
  windowsZipAsset ? "Windows 10, Windows 11" : null,
  macosPkgAsset ? "macOS (Apple Silicon & Intel)" : null,
  ubuntuDebAsset ? "Linux (Ubuntu, Arch, Flatpak)" : null,
].filter(Boolean);

const totalDownloads = release.assets.reduce(
  (acc, asset) => acc + asset.download_count,
  0,
);

const schemaData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: "Live Background Removal Lite",
  headline: "High-performance OBS plugin for real-time background removal",
  softwareVersion: release.tag_name,
  description:
    "A high-performance, crash-resistant OBS plugin for real-time background removal without a physical green screen. Features a smart CPU/GPU hybrid pipeline to keep gaming performance high.",

  screenshot: {
    "@type": "ImageObject",
    contentUrl: joinURL(PRODUCTION_BASE_URL, "screenshot.webp"),
    encodingFormat: "image/webp",
    caption:
      "OBS plugin real-time background removal comparison: Original footage (left) vs. Transparent output (right).",
    width: "1920",
    height: "1080",
    description:
      "A split-screen view of OBS Studio showing the plugin in action. The left side shows the raw camera feed, and the right side demonstrates the background removal effect with a checkerboard pattern.",
  },

  applicationCategory: "MultimediaApplication",
  applicationSubCategory: "OBS Studio Plugin",
  operatingSystem: supportedOSList.join(", "),
  softwareRequirements: "OBS Studio",
  featureList: [
    "Real-time background removal without green screen",
    "CPU/GPU Hybrid Pipeline for low resource usage",
    "Zero-Crash Stability with modern C++ architecture",
    "Support for Windows, macOS, and Linux",
  ],

  downloadUrl: [
    windowsZipAsset?.browser_download_url,
    macosPkgAsset?.browser_download_url,
    ubuntuDebAsset?.browser_download_url,
  ].filter(Boolean),
  fileSize: windowsZipAsset?.size
    ? prettyBytes(windowsZipAsset.size, { binary: true })
    : "10 MiB",
  releaseNotes: release.html_url,

  license: `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/blob/${release.tag_name}/LICENSE`,
  isAccessibleForFree: true,
  offers: {
    "@type": "Offer",
    price: "0",
    priceCurrency: "USD",
    availability: "https://schema.org/InStock",
    seller: {
      "@type": "Person",
      name: "Kaito Udagawa",
    },
  },

  interactionStatistic: {
    "@type": "InteractionCounter",
    interactionType: "https://schema.org/DownloadAction",
    userInteractionCount: totalDownloads,
  },
  author: {
    "@type": "Person",
    name: "Kaito Udagawa",
    url: `https://github.com/${GITHUB_OWNER}`,
  },
  datePublished: release.published_at,
  dateModified: release.published_at,
  sameAs: [`https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}`],
};
---

<Layout
  lang="en"
  title={`Live Background Removal Lite ${release.tag_name} - Download & Release Notes`}
>
  <Fragment slot="head">
    <DefineLocalDate />
    <meta name="description" content={dynamicDescription} />
    <link
      rel="canonical"
      href={withTrailingSlash(
        joinURL(PRODUCTION_BASE_URL, "versions", release.tag_name),
      )}
    />
    <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  </Fragment>

  <main class="white-box">
    <article>
      <hgroup class="version-header">
        <div class="version-title-row">
          <h1>Version {release.tag_name}</h1>
          {
            release.id === latestRelease.id && (
              <span class="badge-latest">Latest</span>
            )
          }
        </div>
        <h2>Live Background Removal Lite</h2>
      </hgroup>

      {
        release.prerelease && (
          <aside class="alert-box" aria-label="Version stability warning">
            <p>
              <strong>Pre-release:</strong>
              This version is unstable. Not recommended for use.
            </p>
          </aside>
        )
      }

      <section class="downloads-section">
        <h2>Downloads</h2>
        {release.body_text}

        <ul class="download-links" style="margin-bottom: 1rem;">
          {
            windowsZipAsset && (
              <li>
                <a href={windowsZipAsset.browser_download_url}>Windows (zip)</a>
              </li>
            )
          }
          {
            macosPkgAsset && (
              <li>
                <a href={macosPkgAsset.browser_download_url}>Mac (pkg)</a>
              </li>
            )
          }
          {
            ubuntuDebAsset && (
              <li>
                <a href={ubuntuDebAsset.browser_download_url}>Ubuntu (deb)</a>
              </li>
            )
          }
        </ul>

        <ul class="download-links" style="margin-bottom: 1rem;">
          <li>
            <a
              href="https://github.com/kaito-tokyo/live-backgroundremoval-lite/tree/main/unsupported/arch"
            >
              Arch Linux (Latest)
            </a>
          </li>

          <li>
            <a
              href="https://github.com/kaito-tokyo/live-backgroundremoval-lite/tree/main/unsupported/flatpak"
            >
              Flatpak (Latest)
            </a>
          </li>
        </ul>
      </section>

      <section class="release-notes">
        <h2>Release notes</h2>
        <pre>{releaseBody}</pre>
      </section>

      <section>
        <h2>Additional Information</h2>
        <dl>
          <dt>Publish date</dt>
          <dd>
            <local-date data-date={release.published_at}
              ><time datetime={release.published_at}
                >{release.published_at}</time
              ></local-date
            >
          </dd>
          {
            windowsZipAsset?.digest && (
              <Fragment>
                <dt>{windowsZipAsset.name}</dt>
                <dd>{prettyBytes(windowsZipAsset.size, { binary: true })}</dd>
                <dd>
                  <code>{windowsZipAsset.digest}</code>
                </dd>
              </Fragment>
            )
          }

          {
            macosPkgAsset?.digest && (
              <Fragment>
                <dt>{macosPkgAsset.name}</dt>
                <dd>{prettyBytes(macosPkgAsset.size, { binary: true })}</dd>
                <dd>
                  <code>{macosPkgAsset.digest}</code>
                </dd>
              </Fragment>
            )
          }

          {
            ubuntuDebAsset?.digest && (
              <Fragment>
                <dt>{ubuntuDebAsset.name}</dt>
                <dd>{prettyBytes(ubuntuDebAsset.size, { binary: true })}</dd>
                <dd>
                  <code>{ubuntuDebAsset.digest}</code>
                </dd>
              </Fragment>
            )
          }
        </dl>
      </section>

      <nav class="page-nav" aria-label="Page navigation">
        <ul>
          <li>
            <a href={withTrailingSlash(BASE_URL)}>Back to Top</a>
          </li>
          <li>
            <a href={withTrailingSlash(joinURL(BASE_URL, "versions"))}
              >Back to Version List</a
            >
          </li>
          <li>
            <a
              href={withTrailingSlash(GITHUB_URL)}
              target="_blank"
              rel="noopener noreferrer">GitHub Repository</a
            >
          </li>
        </ul>
      </nav>
    </article>
  </main>
</Layout>

<style>
  .version-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .version-title-row h1 {
    margin: 0;
  }

  .badge-latest {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    font-size: 0.85rem;
    font-weight: 600;
    line-height: 1;
    color: #ffffff;
    background-color: var(--color-download-button-bg);
    border-radius: 2em;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .alert-box {
    background-color: var(--color-alert-bg);
    color: var(--color-alert-fg);
    padding: 0.5rem 1rem;
    border-radius: 1rem;
  }

  dt {
    font-weight: 600;
  }

  dt,
  dd {
    overflow: hidden;
  }

  .release-notes pre {
    white-space: pre-wrap;
    overflow-wrap: anywhere;
    max-width: 100%;
    background-color: #f8f9fa;
    padding: 1.5rem;
  }
</style>
