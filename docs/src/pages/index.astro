---
import { Octokit } from "@octokit/rest";
import type { GetStaticPathsOptions, GetStaticPathsResult } from "astro";
import { GITHUB_OWNER, GITHUB_REPO } from "../../lib/info.js";
import DefineLocalDate from "../../components/DefineLocalDate.astro";
import Layout from "../../layouts/Layout.astro";

interface Props {
  release: Awaited<
    ReturnType<Octokit["rest"]["repos"]["getReleaseByTag"]>
  >["data"];
}

export async function getStaticPaths(options: GetStaticPathsOptions): Promise<GetStaticPathsResult> {
  const octokit = new Octokit({ auth: import.meta.env.GITHUB_TOKEN });
  const allReleases = await octokit.paginate(octokit.rest.repos.listReleases, {
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
    per_page: 100,
  });
  return allReleases.map((release) => ({
    params: { version: release.tag_name },
    props: { release },
  }));
}

const { release } = Astro.props;

// アセットの特定
const windowsZipAsset = release.assets.find((a) => a.name.endsWith("windows-x64.zip"));
const macosPkgAsset = release.assets.find((a) => a.name.endsWith("macos-universal.pkg"));
const ubuntuDebAsset = release.assets.find((a) => a.name.endsWith("x86_64-linux-gnu.deb"));

// SHA接頭辞削除
const cleanDigest = (digest: string) => digest.replace(/^sha256:/, '');
const releaseBody = release.body || "No release notes provided.";

// JSON-LD
const schemaData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Live Background Removal Lite",
  "softwareVersion": release.tag_name,
  "downloadUrl": [
    windowsZipAsset?.browser_download_url,
    macosPkgAsset?.browser_download_url,
    ubuntuDebAsset?.browser_download_url
  ].filter(Boolean),
  "releaseNotes": release.html_url
};
---

<Layout
  lang="en"
  title={`Version ${release.tag_name} - Live Background Removal Lite`}
>
  <Fragment slot="head">
    <DefineLocalDate />
    <meta name="description" content={`Download version ${release.tag_name}`} />
    <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  </Fragment>

  <main class="white-box">
    <article itemscope itemtype="https://schema.org/SoftwareApplication">
      <header class="version-header">
        <h1 itemprop="name">Version {release.tag_name}</h1>
        <a href={release.html_url} target="_blank" rel="noopener noreferrer" class="github-link">
          View on GitHub ↗
        </a>
      </header>

      <section class="downloads-section">
        <h2>Downloads</h2>

        <div class="download-links">
          <div>
            {windowsZipAsset && (
              <a href={windowsZipAsset.browser_download_url} itemprop="downloadUrl">
                Windows
              </a>
            )}
            {macosPkgAsset && (
              <a href={macosPkgAsset.browser_download_url} itemprop="downloadUrl">
                Mac
              </a>
            )}
            {ubuntuDebAsset && (
              <a href={ubuntuDebAsset.browser_download_url} itemprop="downloadUrl">
                Ubuntu
              </a>
            )}
          </div>
        </div>

        <div class="file-details">
          <h3>File Information</h3>

          {windowsZipAsset && (
            <div class="file-item">
              <div class="platform-label">Windows</div>
              <div class="file-name">{windowsZipAsset.name}</div>
              {windowsZipAsset.digest && (
                <div class="file-hash">
                  <span class="hash-label">SHA-256:</span>
                  <code class="hash-code">{cleanDigest(windowsZipAsset.digest)}</code>
                </div>
              )}
            </div>
          )}

          {macosPkgAsset && (
            <div class="file-item">
              <div class="platform-label">Mac</div>
              <div class="file-name">{macosPkgAsset.name}</div>
              {macosPkgAsset.digest && (
                <div class="file-hash">
                  <span class="hash-label">SHA-256:</span>
                  <code class="hash-code">{cleanDigest(macosPkgAsset.digest)}</code>
                </div>
              )}
            </div>
          )}

          {ubuntuDebAsset && (
            <div class="file-item">
              <div class="platform-label">Ubuntu</div>
              <div class="file-name">{ubuntuDebAsset.name}</div>
              {ubuntuDebAsset.digest && (
                <div class="file-hash">
                  <span class="hash-label">SHA-256:</span>
                  <code class="hash-code">{cleanDigest(ubuntuDebAsset.digest)}</code>
                </div>
              )}
            </div>
          )}
        </div>
      </section>

      <hr />

      <section class="release-notes">
        <h3>Release Log</h3>
        <pre itemprop="releaseNotes">{releaseBody}</pre>
      </section>
    </article>
  </main>
</Layout>

<style>
  /* === 1. ダウンロードボタン（いただいたCSSを適用） === */
  /* 元のCSSセレクタ (.download-links > div) が効くようにHTML構造を合わせています */

  .download-links {
    margin-bottom: 3rem; /* 下の詳細情報との余白を追加 */
  }

  .download-links > div {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .download-links > div a {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 20px;

    /* 変数が定義されていない場合のフォールバック色 (#007bff) を追加 */
    background-color: var(--color-download-button-bg, #007bff);
    color: var(--color-download-button-fg, #fff);

    text-align: center;
    text-decoration: none;
    font-size: 18px;
    border-radius: 5px;
    transition: background-color 0.3s ease;
  }

  .download-links > div a:hover {
    background-color: var(--color-download-button-active-bg, #0056b3);
  }


  /* === ヘッダー周り === */
  .version-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  .github-link {
    font-size: 0.9rem;
    color: #666;
    text-decoration: none;
  }
  .github-link:hover {
    text-decoration: underline;
  }

  /* === 2. ファイル詳細情報（縦並び） === */
  .file-details {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid #eee;
  }

  .file-details h3 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    font-size: 1rem;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #eee;
    padding-bottom: 0.5rem;
  }

  .file-item {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px dashed #ddd;
  }
  .file-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .platform-label {
    font-size: 0.85rem;
    font-weight: bold;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
  }

  .file-name {
    font-family: Consolas, Monaco, monospace;
    font-weight: bold;
    color: #333;
    word-break: break-all;
    margin-bottom: 8px;
  }

  .file-hash {
    font-family: Consolas, Monaco, monospace;
    font-size: 0.8rem;
    color: #666;
    background: #fff;
    padding: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  .hash-label {
    font-weight: bold;
    color: #999;
    user-select: none;
  }

  .hash-code {
    word-break: break-all;
    user-select: all;
  }

  /* === ログ === */
  .release-notes pre {
    white-space: pre-wrap;
    overflow-wrap: anywhere;
    max-width: 100%;
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 6px;
    font-family: Consolas, monospace;
    line-height: 1.5;
  }

  hr {
    border: 0;
    border-top: 1px solid #eee;
    margin: 3rem 0;
  }
</style>
