---
import { joinURL, withTrailingSlash } from "ufo";
import { Octokit, type RestEndpointMethodTypes } from "@octokit/rest";

import Layout from "../layouts/Layout.astro";

import {
  GITHUB_OWNER,
  GITHUB_REPO,
  GITHUB_URL,
  PRODUCTION_BASE_URL,
} from "../lib/info.js";

export type LatestRelease =
  RestEndpointMethodTypes["repos"]["getLatestRelease"]["response"]["data"];

const { BASE_URL } = import.meta.env;

async function getLatestRelease(): Promise<LatestRelease> {
  const octokit = new Octokit({ auth: import.meta.env.GITHUB_TOKEN });

  const latestRelease = await octokit.rest.repos.getLatestRelease({
    owner: GITHUB_OWNER,
    repo: GITHUB_REPO,
  });

  return latestRelease.data;
}

const release = await getLatestRelease();

const windowsZipAsset = release.assets.find((a) =>
  a.name.endsWith("windows-x64.zip"),
);
const macosPkgAsset = release.assets.find((a) =>
  a.name.endsWith("macos-universal.pkg"),
);
const ubuntuDebAsset = release.assets.find((a) =>
  a.name.endsWith("x86_64-linux-gnu.deb"),
);
---

<Layout lang="en" title="How to install?">
  <Fragment slot="head">
    <meta
      name="description"
      content="Instructions for installing Live Background Removal Lite on various operating systems."
    />
    <link
      rel="canonical"
      href={withTrailingSlash(joinURL(PRODUCTION_BASE_URL, "install"))}
    />
  </Fragment>

  <main class="white-box">
    <h1>How to install?</h1>
    <h2>Windows</h2>
    <ol>
      <li>
        <strong>Download:</strong>
        <a href={windowsZipAsset?.browser_download_url}
          ><code>{windowsZipAsset?.name}</code></a
        > (latest release for Windows)
      </li>
      <li>
        Extract the <code>obs-plugins</code> and <code>data</code> folders from the
        zip file.<br />
        Drag and drop the <code>obs-plugins</code> and <code>data</code> folders from
        the zip file into your OBS Studio installation directory (<code
          >C:\Program Files\obs-studio</code
        >), and choose to overwrite when prompted.
      </li>
      <li>Restart OBS Studio.</li>
      <li>
        <strong>Test your installation:</strong> Open OBS Studio, right-click your
        video source, go to <b>Filters</b>, and check if <b
          >Live Background Removal Lite</b
        > appears in the <b>Effect Filters</b> list.<br />
        For usage instructions, see the <a
          href={withTrailingSlash(joinURL(BASE_URL, "usage"))}>usage page</a
        >.
      </li>
    </ol>

    <h2>macOS</h2>
    <ol>
      <li>
        <strong>Download:</strong>
        <a href={macosPkgAsset?.browser_download_url}
          ><code>{macosPkgAsset?.name}</code></a
        > (latest release for macOS)
      </li>
      <li>
        Run the installer and follow the prompts to complete installation.
      </li>
      <li>Restart OBS Studio.</li>
      <li>
        <strong>Test your installation:</strong> Open OBS Studio, right-click your
        video source, go to <b>Filters</b>, and check if <b
          >Live Background Removal Lite</b
        > appears in the <b>Effect Filters</b> list.<br />
        For usage instructions, see the <a
          href={withTrailingSlash(joinURL(BASE_URL, "usage"))}>usage page</a
        >.
      </li>
    </ol>

    <h2>Ubuntu</h2>
    <ol>
      <li>
        <strong>Download:</strong>
        <a href={ubuntuDebAsset?.browser_download_url}
          ><code>{ubuntuDebAsset?.name}</code></a
        > (latest release for Ubuntu)
      </li>
      <li>
        <strong>Install the package:</strong><br />
        <ul>
          <li>
            <strong>Terminal Way:</strong> Open a terminal and run:<br /><code
              >sudo dpkg -i ./{`${ubuntuDebAsset?.name}`}</code
            >
          </li>
          <li>
            <strong>GUI Way:</strong> Double-click the <code
              >{`${ubuntuDebAsset?.name}`}</code
            > file in your file manager and follow the on-screen instructions.
          </li>
        </ul>
      </li>
      <li>Restart OBS Studio.</li>
      <li>
        <strong>Test your installation:</strong> Open OBS Studio, right-click your
        video source, go to <b>Filters</b>, and check if <b
          >Live Background Removal Lite</b
        > appears in the <b>Effect Filters</b> list.<br />
        For usage instructions, see the <a
          href={withTrailingSlash(joinURL(BASE_URL, "usage"))}>usage page</a
        >.
      </li>
    </ol>

    <h2>Arch Linux</h2>
    <p>
      For Arch Linux, we provide an <strong>unofficial PKGBUILD</strong> in the repository.<br
      />
      You can install this plugin by building with <code>makepkg</code> or using an
      AUR helper like <code>yay</code>.<br />
      For detailed instructions, see:<br />
      <a
        href={withTrailingSlash(
          joinURL(GITHUB_URL, "tree/main/unsupported/arch/"),
        )}>Arch Linux packaging documentation</a
      >
    </p>

    <h2>Flatpak</h2>
    <p>
      For Flatpak, we provide an <strong>unofficial build definition</strong> in the
      repository.<br />
      Users can build and install this plugin using <code>flatpak-builder</code
      >.<br />
      For detailed instructions, see:<br />
      <a
        href={withTrailingSlash(
          joinURL(GITHUB_URL, "tree/main/unsupported/flatpak/"),
        )}>Flatpak packaging documentation</a
      >
    </p>

    <nav class="page-nav" aria-label="Page navigation">
      <ul>
        <li>
          <a href={withTrailingSlash(BASE_URL)}>Back to Top</a>
        </li>
        <li>
          <a
            href={withTrailingSlash(GITHUB_URL)}
            target="_blank"
            rel="noopener noreferrer">GitHub Repository</a
          >
        </li>
      </ul>
    </nav>
  </main>
</Layout>
